name: Build Release

on:
  workflow_dispatch:
    inputs:
      tag_version:
        description: 'Specify the version tag (required)'
        required: true

jobs:
  # -----------------------------------------------------------------
  # ä½œä¸š 1ï¼šæ„å»ºã€é‡å‘½åå¹¶ä¸Šä¼ æ‰€æœ‰å¹³å°çš„äº§ç‰©
  # -----------------------------------------------------------------
  build-and-rename:
    strategy:
      matrix:
        include:
          # Windows
          - os: windows-latest
            name: windows-x64
          - os: windows-11-arm
            name: windows-arm64
          # Linux
          - os: ubuntu-latest
            name: linux-amd64
            rpm_arch: linux-x86_64
          - os: ubuntu-24.04-arm
            name: linux-arm64
            rpm_arch: linux-aarch64
          # macOS
          - os: macos-15-intel
            name: macos-x64
          - os: macos-latest # Apple Silicon
            name: macos-arm64

    runs-on: ${{ matrix.os }}
    name: Build for ${{ matrix.name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Package Release Distribution
        run: ./gradlew packageReleaseDistributionForCurrentOS

      - name: Rename Windows Files
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $basePath = "${{ github.workspace }}\composeApp\output\main-release"
          $suffix = "${{ matrix.name }}"
          Write-Host "ğŸ” Searching for MSI and EXE files in $basePath for $suffix..."

          $msi = Get-ChildItem -Path "$basePath\msi" -Filter "*.msi" -File -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($null -ne $msi) {
            $msiDest = "$basePath\msi\AndroidToolKit-$suffix.msi"
            Write-Host "Renaming $($msi.FullName) -> $msiDest"
            Move-Item -Path $msi.FullName -Destination $msiDest -Force
          } else {
            Write-Warning "âš ï¸ No .msi file found"
          }

          $exe = Get-ChildItem -Path "$basePath\exe" -Filter "*.exe" -File -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($null -ne $exe) {
            $exeDest = "$basePath\exe\AndroidToolKit-$suffix.exe"
            Write-Host "Renaming $($exe.FullName) -> $exeDest"
            Move-Item -Path $exe.FullName -Destination $exeDest -Force
          } else {
            Write-Warning "âš ï¸ No .exe file found"
          }
          Write-Host "âœ… Rename complete for $suffix."

      - name: Rename Linux Files
        if: runner.os == 'Linux'
        run: |
          set -e
          BASE_PATH="${{ github.workspace }}/composeApp/output/main-release"
          echo "ğŸ” Searching for DEB and RPM files for ${{ matrix.name }}..."

          DEB_SRC=$(find "$BASE_PATH/deb" -type f -name "*.deb" | head -n 1 || true)
          if [ -n "$DEB_SRC" ]; then
            DEB_DEST="$BASE_PATH/deb/AndroidToolKit-${{ matrix.name }}.deb"
            echo "Renaming: $DEB_SRC -> $DEB_DEST"
            mv "$DEB_SRC" "$DEB_DEST"
          else
            echo "âš ï¸ No .deb file found"
          fi

          RPM_SRC=$(find "$BASE_PATH/rpm" -type f -name "*.rpm" | head -n 1 || true)
          if [ -n "$RPM_SRC" ]; then
            RPM_DEST="$BASE_PATH/rpm/AndroidToolKit-${{ matrix.rpm_arch }}.rpm" # æ³¨æ„è¿™é‡Œç”¨äº†ä¸“é—¨çš„ rpm_arch
            echo "Renaming: $RPM_SRC -> $RPM_DEST"
            mv "$RPM_SRC" "$RPM_DEST"
          else
            echo "âš ï¸ No .rpm file found"
          fi
          echo "âœ… Rename complete for ${{ matrix.name }}."

      - name: Rename macOS File
        if: runner.os == 'macOS'
        run: |
          set -e
          BASE_PATH="${{ github.workspace }}/composeApp/output/main-release"
          echo "ğŸ” Searching for macOS build artifacts for ${{ matrix.name }}..."

          DMG_SRC=$(find "$BASE_PATH/dmg" -type f -name "*.dmg" | head -n 1 || true)
          if [ -n "$DMG_SRC" ]; then
            DMG_DEST="$BASE_PATH/dmg/AndroidToolKit-${{ matrix.name }}.dmg"
            echo "Renaming: $DMG_SRC -> $DMG_DEST"
            mv "$DMG_SRC" "$DMG_DEST"
          else
            echo "âš ï¸ No .dmg file found"
          fi
          echo "âœ… Rename complete for ${{ matrix.name }}."

      # --- ä¸Šä¼ äº§ç‰©ï¼ˆä¸º Job 2 å‡†å¤‡ï¼‰---
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-${{ matrix.name }} # æ¯ä¸ª job çš„äº§ç‰©åŒ…åå”¯ä¸€
          path: | # ä½¿ç”¨é€šé…ç¬¦åŒ¹é…æ‰€æœ‰é‡å‘½ååçš„æ–‡ä»¶
            ${{ github.workspace }}/composeApp/output/main-release/msi/*.msi
            ${{ github.workspace }}/composeApp/output/main-release/exe/*.exe
            ${{ github.workspace }}/composeApp/output/main-release/deb/*.deb
            ${{ github.workspace }}/composeApp/output/main-release/rpm/*.rpm
            ${{ github.workspace }}/composeApp/output/main-release/dmg/*.dmg
          if-no-files-found: warn # å¦‚æœæŸä¸ªå¹³å°æ²¡æœ‰äº§ç‰©ï¼ˆä¾‹å¦‚ Linux æ²¡æœ‰ .msiï¼‰ä¹Ÿä¸è¦æŠ¥é”™
          retention-days: 1 # åªéœ€è¦ä¿ç•™1å¤©ï¼ŒJob 2 ç”¨å®Œå°±ä¸¢

  # -----------------------------------------------------------------
  # ä½œä¸š 2ï¼šæ”¶é›†æ‰€æœ‰äº§ç‰©å¹¶åˆ›å»ºï¼ˆæˆ–æ›´æ–°ï¼‰ä¸€ä¸ª Release
  # -----------------------------------------------------------------
  publish-release:
    name: Publish Draft Release
    runs-on: ubuntu-latest
    needs: build-and-rename # å…³é”®ï¼šç­‰å¾…æ‰€æœ‰ build-and-rename ä»»åŠ¡æˆåŠŸ

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets # ä¸‹è½½åˆ°è¿™ä¸ªç›®å½•
          pattern: release-assets-* # åŒ¹é…æ‰€æœ‰ job ä¸Šä¼ çš„äº§ç‰©
          merge-multiple: true # å…³é”®ï¼šå°†æ‰€æœ‰äº§ç‰©åŒ…åˆå¹¶åˆ° release-assets ç›®å½•ä¸‹

      - name: List downloaded files (for debugging)
        run: |
          echo "Listing all downloaded artifacts:"
          ls -R release-assets

      - name: Draft Release
        uses: ncipollo/release-action@v1
        with:
          draft: true
          allowUpdates: true
          tag: "v${{ inputs.tag_version }}"
          artifacts: "release-assets/*/*" # ä¸Šä¼ ä¸‹è½½ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
          token: ${{ secrets.GH_TOKEN }}