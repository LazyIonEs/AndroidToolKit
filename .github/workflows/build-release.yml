name: Build Release

on:
  workflow_dispatch:

jobs:
  # -----------------------------------------------------------------
  # 作业 1：获取版本号
  # -----------------------------------------------------------------
  get-version:
    name: Get Version
    runs-on: ubuntu-latest
    outputs:
      # 将版本号定义为作业输出
      version_tag: ${{ steps.get_version.outputs.version_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read Version from gradle.properties
        id: get_version # 给予此步骤一个 ID
        run: |
          VERSION=$(grep 'kitVersion=' gradle.properties | cut -d'=' -f2)
          if [ -z "$VERSION" ]; then
            echo "::error::kitVersion not found in gradle.properties"
            exit 1
          fi
          echo "Found version: $VERSION"
          echo "version_tag=v${VERSION}" >> $GITHUB_OUTPUT

  # -----------------------------------------------------------------
  # 作业 2：构建、重命名并上传所有平台的产物
  # -----------------------------------------------------------------
  build-and-rename:
    strategy:
      matrix:
        include:
          - os: windows-latest
            name: windows-x64
          - os: windows-11-arm
            name: windows-arm64
          - os: ubuntu-latest
            name: linux-amd64
            rpm_arch: linux-x86_64
          - os: ubuntu-24.04-arm
            name: linux-arm64
            rpm_arch: linux-aarch64
          - os: macos-15-intel
            name: macos-x64
          - os: macos-latest
            name: macos-arm64

    runs-on: ${{ matrix.os }}
    name: Build for ${{ matrix.name }}
    needs: get-version

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ... (你所有的构建和重命名步骤保持不变) ...

      - name: Package Release Distribution
        run: ./gradlew packageReleaseDistributionForCurrentOS

      - name: Rename Windows Files
        if: runner.os == 'Windows'
        # ... (pwsh script) ...
        shell: pwsh
        run: |
          $basePath = "${{ github.workspace }}\composeApp\output\main-release"
          $suffix = "${{ matrix.name }}"
          # ... (rest of the script) ...

      - name: Rename Linux Files
        if: runner.os == 'Linux'
        # ... (bash script) ...
        run: |
          set -e
          BASE_PATH="${{ github.workspace }}/composeApp/output/main-release"
          # ... (rest of the script) ...

      - name: Rename macOS File
        if: runner.os == 'macOS'
        # ... (bash script) ...
        run: |
          set -e
          BASE_PATH="${{ github.workspace }}/composeApp/output/main-release"
          # ... (rest of the script) ...

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-${{ matrix.name }}
          path: |
            ${{ github.workspace }}/composeApp/output/main-release/msi/*.msi
            ${{ github.workspace }}/composeApp/output/main-release/exe/*.exe
            ${{ github.workspace }}/composeApp/output/main-release/deb/*.deb
            ${{ github.workspace }}/composeApp/output/main-release/rpm/*.rpm
            ${{ github.workspace }}/composeApp/output/main-release/dmg/*.dmg
          if-no-files-found: warn
          retention-days: 1

  # -----------------------------------------------------------------
  # 作业 3：收集所有产物并创建（或更新）一个 Release
  # -----------------------------------------------------------------
  publish-release:
    name: Publish Draft Release
    runs-on: ubuntu-latest
    needs: [get-version, build-and-rename]

    steps:
      # --- 不再需要 Checkout 和 Read Version ---

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          pattern: release-assets-*
          merge-multiple: true

      - name: List downloaded files (for debugging)
        run: |
          echo "Listing all downloaded artifacts:"
          ls -R release-assets

      - name: Draft Release
        uses: ncipollo/release-action@v1
        with:
          draft: true
          allowUpdates: true
          # --- 关键修改：从 needs.get-version 上下文获取 tag ---
          tag: ${{ needs.get-version.outputs.version_tag }}
          artifacts: "release-assets/*/*" # <--- 修正后的通配符
          token: ${{ secrets.GH_TOKEN }}