name: Build Release

on:
  workflow_dispatch:

jobs:
  get-version:
    name: Get Version
    runs-on: ubuntu-latest
    outputs:
      version_tag: ${{ steps.get_version.outputs.version_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read Version from gradle.properties
        id: get_version
        run: |
          VERSION=$(grep 'kitVersion=' gradle.properties | cut -d'=' -f2)
          if [ -z "$VERSION" ]; then
            echo "::error::kitVersion not found in gradle.properties"
            exit 1
          fi
          echo "Found version: $VERSION"
          echo "version_tag=v${VERSION}" >> $GITHUB_OUTPUT

  build-and-rename:
    strategy:
      matrix:
        include:
          - os: windows-latest
            name: windows-x64
          - os: windows-11-arm
            name: windows-arm64
          - os: ubuntu-latest
            name: linux-amd64
            rpm_arch: linux-x86_64
          - os: ubuntu-24.04-arm
            name: linux-arm64
            rpm_arch: linux-aarch64
          - os: macos-15-intel
            name: macos-x64
          - os: macos-latest
            name: macos-arm64

    runs-on: ${{ matrix.os }}
    name: Build for ${{ matrix.name }}
    needs: get-version

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK (x64)
        if: runner.arch == 'X64'
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "21"
          architecture: x64
          cache: 'gradle'

      - name: Setup JDK (ARM64)
        if: runner.arch == 'ARM64'
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "21"
          architecture: aarch64
          cache: 'gradle'

      - name: Package Release Distribution
        run: ./gradlew packageReleaseDistributionForCurrentOS

      - name: Rename Windows Files
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $basePath = "${{ github.workspace }}\composeApp\output\main-release"
          $suffix = "${{ matrix.name }}"
          Write-Host "üîç Searching for MSI and EXE files in $basePath for $suffix..."

          $msi = Get-ChildItem -Path "$basePath\msi" -Filter "*.msi" -File -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($null -ne $msi) {
            $msiDest = "$basePath\msi\AndroidToolKit-$suffix.msi"
            Write-Host "Renaming $($msi.FullName) -> $msiDest"
            Move-Item -Path $msi.FullName -Destination $msiDest -Force
          } else {
            Write-Warning "‚ö†Ô∏è No .msi file found"
          }

          $exe = Get-ChildItem -Path "$basePath\exe" -Filter "*.exe" -File -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($null -ne $exe) {
            $exeDest = "$basePath\exe\AndroidToolKit-$suffix.exe"
            Write-Host "Renaming $($exe.FullName) -> $exeDest"
            Move-Item -Path $exe.FullName -Destination $exeDest -Force
          } else {
            Write-Warning "‚ö†Ô∏è No .exe file found"
          }
          Write-Host "‚úÖ Rename complete for $suffix."

      - name: Rename Linux Files
        if: runner.os == 'Linux'
        run: |
          set -e
          BASE_PATH="${{ github.workspace }}/composeApp/output/main-release"
          echo "üîç Searching for DEB and RPM files for ${{ matrix.name }}..."

          DEB_SRC=$(find "$BASE_PATH/deb" -type f -name "*.deb" | head -n 1 || true)
          if [ -n "$DEB_SRC" ]; then
            DEB_DEST="$BASE_PATH/deb/AndroidToolKit-${{ matrix.name }}.deb"
            echo "Renaming: $DEB_SRC -> $DEB_DEST"
            mv "$DEB_SRC" "$DEB_DEST"
          else
            echo "‚ö†Ô∏è No .deb file found"
          fi

          RPM_SRC=$(find "$BASE_PATH/rpm" -type f -name "*.rpm" | head -n 1 || true)
          if [ -n "$RPM_SRC" ]; then
            RPM_DEST="$BASE_PATH/rpm/AndroidToolKit-${{ matrix.rpm_arch }}.rpm" # Ê≥®ÊÑèËøôÈáåÁî®‰∫Ü‰∏ìÈó®ÁöÑ rpm_arch
            echo "Renaming: $RPM_SRC -> $RPM_DEST"
            mv "$RPM_SRC" "$RPM_DEST"
          else
            echo "‚ö†Ô∏è No .rpm file found"
          fi
          echo "‚úÖ Rename complete for ${{ matrix.name }}."

      - name: Rename macOS File
        if: runner.os == 'macOS'
        run: |
          set -e
          BASE_PATH="${{ github.workspace }}/composeApp/output/main-release"
          echo "üîç Searching for macOS build artifacts for ${{ matrix.name }}..."

          DMG_SRC=$(find "$BASE_PATH/dmg" -type f -name "*.dmg" | head -n 1 || true)
          if [ -n "$DMG_SRC" ]; then
            DMG_DEST="$BASE_PATH/dmg/AndroidToolKit-${{ matrix.name }}.dmg"
            echo "Renaming: $DMG_SRC -> $DMG_DEST"
            mv "$DMG_SRC" "$DMG_DEST"
          else
            echo "‚ö†Ô∏è No .dmg file found"
          fi
          echo "‚úÖ Rename complete for ${{ matrix.name }}."

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-${{ matrix.name }}
          path: |
            ${{ github.workspace }}/composeApp/output/main-release/msi/*.msi
            ${{ github.workspace }}/composeApp/output/main-release/exe/*.exe
            ${{ github.workspace }}/composeApp/output/main-release/deb/*.deb
            ${{ github.workspace }}/composeApp/output/main-release/rpm/*.rpm
            ${{ github.workspace }}/composeApp/output/main-release/dmg/*.dmg
          if-no-files-found: warn
          retention-days: 1

  publish-release:
    name: Publish Draft Release
    runs-on: ubuntu-latest
    needs: [get-version, build-and-rename]

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          pattern: release-assets-*
          merge-multiple: true

      - name: List downloaded files (for debugging)
        run: |
          echo "Listing all downloaded artifacts:"
          ls -R release-assets

      - name: Draft Release
        uses: ncipollo/release-action@v1
        with:
          draft: true
          allowUpdates: true
          tag: ${{ needs.get-version.outputs.version_tag }}
          artifacts: "release-assets/*/*"
          token: ${{ secrets.GH_TOKEN }}