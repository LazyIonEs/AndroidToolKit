name: Build Release

on:
  workflow_dispatch:
    inputs:
      tag_version:
        description: 'Specify the version tag (required)'
        required: true
jobs:
  create-release-distribution:
    strategy:
      matrix:
        os: [ windows-latest, windows-11-arm, ubuntu-latest, ubuntu-24.04-arm, macos-15-intel, macos-latest ]
    runs-on: ${{ matrix.os }}
    name: Create Release Distribution

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: PackageReleaseDistributionForCurrentOS
        run: ./gradlew packageReleaseDistributionForCurrentOS

      - if: matrix.os == 'windows-latest'
        name: Rename File
        run: |
          $basePath = "D:\a\AndroidToolKit\AndroidToolKit\composeApp\output\main-release"

          Write-Host "üîç Searching for MSI and EXE files..."

          # Êü•Êâæ .msi Êñá‰ª∂
          $msi = Get-ChildItem -Path "$basePath\msi" -Filter "*.msi" -File -ErrorAction SilentlyContinue | Select-Object -First 1
          # Êü•Êâæ .exe Êñá‰ª∂
          $exe = Get-ChildItem -Path "$basePath\exe" -Filter "*.exe" -File -ErrorAction SilentlyContinue | Select-Object -First 1

          if ($null -ne $msi) {
            $msiDest = "$basePath\msi\AndroidToolKit-windows-x64.msi"
            Write-Host "Renaming $($msi.FullName) -> $msiDest"
            Move-Item -Path $msi.FullName -Destination $msiDest -Force
          } else {
            Write-Warning "‚ö†Ô∏è No .msi file found in $basePath\msi"
          }

          if ($null -ne $exe) {
            $exeDest = "$basePath\exe\AndroidToolKit-windows-x64.exe"
            Write-Host "Renaming $($exe.FullName) -> $exeDest"
            Move-Item -Path $exe.FullName -Destination $exeDest -Force
          } else {
            Write-Warning "‚ö†Ô∏è No .exe file found in $basePath\exe"
          }

          Write-Host "‚úÖ Rename complete."

      - if: matrix.os == 'windows-11-arm'
        name: Rename File
        run: |
          $basePath = "D:\a\AndroidToolKit\AndroidToolKit\composeApp\output\main-release"

          Write-Host "üîç Searching for MSI and EXE files..."

          # Êü•Êâæ .msi Êñá‰ª∂
          $msi = Get-ChildItem -Path "$basePath\msi" -Filter "*.msi" -File -ErrorAction SilentlyContinue | Select-Object -First 1
          # Êü•Êâæ .exe Êñá‰ª∂
          $exe = Get-ChildItem -Path "$basePath\exe" -Filter "*.exe" -File -ErrorAction SilentlyContinue | Select-Object -First 1

          if ($null -ne $msi) {
            $msiDest = "$basePath\msi\AndroidToolKit-windows-arm64.msi"
            Write-Host "Renaming $($msi.FullName) -> $msiDest"
            Move-Item -Path $msi.FullName -Destination $msiDest -Force
          } else {
            Write-Warning "‚ö†Ô∏è No .msi file found in $basePath\msi"
          }

          if ($null -ne $exe) {
            $exeDest = "$basePath\exe\AndroidToolKit-windows-arm64.exe"
            Write-Host "Renaming $($exe.FullName) -> $exeDest"
            Move-Item -Path $exe.FullName -Destination $exeDest -Force
          } else {
            Write-Warning "‚ö†Ô∏è No .exe file found in $basePath\exe"
          }

          Write-Host "‚úÖ Rename complete."

      - if: matrix.os == 'ubuntu-latest'
        name: Rename File
        run: |
          set -e  # Âá∫ÈîôÁ´ãÂç≥ÁªàÊ≠¢
          BASE_PATH="/home/runner/work/AndroidToolKit/AndroidToolKit/composeApp/output/main-release"
          
          echo "üîç Searching for DEB and RPM files..."
          
          DEB_SRC=$(find "$BASE_PATH/deb" -type f -name "*.deb" | head -n 1 || true)
          RPM_SRC=$(find "$BASE_PATH/rpm" -type f -name "*.rpm" | head -n 1 || true)
          
          if [ -z "$DEB_SRC" ]; then
            echo "‚ö†Ô∏è No .deb file found in $BASE_PATH/deb"
          else
            DEB_DEST="$BASE_PATH/deb/AndroidToolKit-linux-amd64.deb"
          echo "Renaming: $DEB_SRC -> $DEB_DEST"
            mv "$DEB_SRC" "$DEB_DEST"
          fi
          
          if [ -z "$RPM_SRC" ]; then
            echo "‚ö†Ô∏è No .rpm file found in $BASE_PATH/rpm"
          else
            RPM_DEST="$BASE_PATH/rpm/AndroidToolKit-linux-x86_64.rpm"
          echo "Renaming: $RPM_SRC -> $RPM_DEST"
            mv "$RPM_SRC" "$RPM_DEST"
          fi
          
          echo "‚úÖ Rename complete."

      - if: matrix.os == 'ubuntu-24.04-arm'
        name: Rename File
        run: |
          set -e  # Âá∫ÈîôÁ´ãÂç≥ÁªàÊ≠¢
          BASE_PATH="/home/runner/work/AndroidToolKit/AndroidToolKit/composeApp/output/main-release"
          
          echo "üîç Searching for DEB and RPM files..."
          
          DEB_SRC=$(find "$BASE_PATH/deb" -type f -name "*.deb" | head -n 1 || true)
          RPM_SRC=$(find "$BASE_PATH/rpm" -type f -name "*.rpm" | head -n 1 || true)
          
          if [ -z "$DEB_SRC" ]; then
            echo "‚ö†Ô∏è No .deb file found in $BASE_PATH/deb"
          else
            DEB_DEST="$BASE_PATH/deb/AndroidToolKit-linux-arm64.deb"
          echo "Renaming: $DEB_SRC -> $DEB_DEST"
            mv "$DEB_SRC" "$DEB_DEST"
          fi
          
          if [ -z "$RPM_SRC" ]; then
            echo "‚ö†Ô∏è No .rpm file found in $BASE_PATH/rpm"
          else
            RPM_DEST="$BASE_PATH/rpm/AndroidToolKit-linux-aarch64.rpm"
          echo "Renaming: $RPM_SRC -> $RPM_DEST"
            mv "$RPM_SRC" "$RPM_DEST"
          fi
          
          echo "‚úÖ Rename complete."

      - if: matrix.os == 'macos-15-intel'
        name: Rename File
        run: |
          set -e
          BASE_PATH="/Users/runner/work/AndroidToolKit/AndroidToolKit/composeApp/output/main-release"
          echo "üîç Searching for macOS build artifacts..."

          DMG_SRC=$(find "$BASE_PATH/dmg" -type f -name "*.dmg" | head -n 1 || true)
          if [ -n "$DMG_SRC" ]; then
            mv "$DMG_SRC" "$BASE_PATH/dmg/AndroidToolKit-macos-x64.dmg"
            echo "‚úÖ Renamed DMG -> AndroidToolKit-macos-x64.dmg"
          else
            echo "‚ö†Ô∏è No .dmg file found"
          fi

      - if: matrix.os == 'macos-latest'
        name: Rename File
        run: |
          set -e
          BASE_PATH="/Users/runner/work/AndroidToolKit/AndroidToolKit/composeApp/output/main-release"
          echo "üîç Searching for macOS build artifacts..."

          DMG_SRC=$(find "$BASE_PATH/dmg" -type f -name "*.dmg" | head -n 1 || true)
          if [ -n "$DMG_SRC" ]; then
            mv "$DMG_SRC" "$BASE_PATH/dmg/AndroidToolKit-macos-arm64.dmg"
            echo "‚úÖ Renamed DMG -> AndroidToolKit-macos-arm64.dmg"
          else
            echo "‚ö†Ô∏è No .dmg file found"
          fi

      - if: matrix.os == 'windows-latest' || matrix.os == 'windows-11-arm'
        name: Draft Release
        uses: ncipollo/release-action@v1
        with:
          draft: true
          allowUpdates: true
          tag: "v${{ inputs.tag_version }}"
          artifacts: "composeApp/output/main-release/msi/*,composeApp/output/main-release/exe/*"
          token: ${{ secrets.GH_TOKEN }}

      - if: matrix.os == 'ubuntu-latest' || matrix.os == 'ubuntu-24.04-arm'
        name: Draft Release
        uses: ncipollo/release-action@v1
        with:
          draft: true
          allowUpdates: true
          tag: "v${{ inputs.tag_version }}"
          artifacts: "composeApp/output/main-release/deb/*,composeApp/output/main-release/rpm/*"
          token: ${{ secrets.GH_TOKEN }}

      - if: matrix.os == 'macos-15-intel' || matrix.os == 'macos-latest'
        name: Draft Release
        uses: ncipollo/release-action@v1
        with:
          draft: true
          allowUpdates: true
          tag: "v${{ inputs.tag_version }}"
          artifacts: "composeApp/output/main-release/dmg/*"
          token: ${{ secrets.GH_TOKEN }}